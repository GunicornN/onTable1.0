#------------------------------
# Final version  
#------------------------------

server {
    # Accept ontable.fr and 35.181.132.20 urls
    # Redirect from www website to non-www website
    server_name ontable.fr 35.181.132.20 www.ontable.fr;

    ## Only allow these request methods ##
     if ($request_method !~ ^(GET|HEAD|POST)$ ) {
         return 444;
     }
    ## Do not accept DELETE, SEARCH and other methods ##

    # hide hidden files
    location ~ /\.  { return 403; } 

    # hide .py files
    location ~ \.py$  { return 404; } 

    location / {
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_redirect off;
	    client_max_body_size 500M;
        if (!-f $request_filename) {
            proxy_pass http://0.0.0.0:8080;
            break;
        }
    }

    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/ontable.fr/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/ontable.fr/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot


}
server {
    listen 80;
    server_name ontable.fr www.ontable.fr 35.181.132.20;
    return 301 https://ontable.fr$request_uri;
}


#------------------------------
# WITHOUT CERTBOT 
#------------------------------
server {
    listen 80;
    server_name ontable.fr www.ontable.fr 35.181.132.20;

    # hide hidden files
    location ~ /\.  { return 403; } 

    # hide .py files
    location ~ \.py$  { return 404; } 

    location / {
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_redirect off;
        if (!-f $request_filename) {
            proxy_pass http://0.0.0.0:8080;
            break;
        }
    }
}

server {
    listen 80;
    server_name www.ontable.fr;
    
    location / {
        proxy_pass http://0.0.0.0:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_connect_timeout 150;
        proxy_send_timeout 100;
        proxy_read_timeout 100;
        proxy_buffers 4 32k;
        client_max_body_size 8m;
        client_body_buffer_size 128k;        
    }
}
#------------------------------
# WITH CERTBOT 
#------------------------------

server {
    server_name www.ontable.fr;
    return 301 $scheme://ontable.fr$request_uri;


    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/ontable.fr/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/ontable.fr/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

}


server {
    server_name ontable.fr;

    location ~ /\.  { return 403; }
    location ~ \.py$  { return 404; }

    location /static {
        alias /home/manager/onTablePro/static/;
    }

    location / {
        client_max_body_size 500M;
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_redirect off;
        if (!-f $request_filename) {
            proxy_pass http://127.0.0.1:8080;
            break;
        }
    }

    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/ontable.fr/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/ontable.fr/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

}

server {
    if ($host = ontable.fr) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


    listen 80;
 	client_max_body_size 500M;
    server_name ontable.fr;
    return 404;
}
